<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="AI Research Agent - Intelligent research assistant powered by LangChain and LLaMA 3">
    <title>AI Research Agent | Intelligent Research Assistant</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤–</text></svg>">
</head>

<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">ğŸ¤–</div>
                <div class="logo-text">
                    <h1>AI Research Agent</h1>
                    <span>Powered by LLaMA 3</span>
                </div>
            </div>
            <div class="header-badge">
                <span class="status-dot"></span>
                Online & Ready
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Hero Section -->
        <div class="hero">
            <h2>Research Smarter, Not Harder</h2>
            <p>Ask any question and get comprehensive, verified answers from multiple sources with confidence scoring.
            </p>
        </div>

        <!-- Search Section -->
        <div class="search-container">
            <h3>ğŸ’¡ What would you like to research?</h3>
            <div class="input-wrapper">
                <input type="text" id="query" placeholder="e.g., What are the latest developments in quantum computing?"
                    autocomplete="off" autofocus>
            </div>
            <button onclick="askAgent()" id="askButton">
                âœ¨ Start Research
            </button>
            <div class="feature-pills">
                <span class="pill">ğŸ” Web Search</span>
                <span class="pill">ğŸ“š Wikipedia</span>
                <span class="pill">ğŸ“Š Confidence Score</span>
                <span class="pill">âš¡ Real-time</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="hidden">
            <div class="loading-content">
                <div class="spinner-container">
                    <div class="spinner"></div>
                    <div class="spinner-inner"></div>
                </div>
                <p class="loading-text">
                    <span>R</span><span>e</span><span>s</span><span>e</span><span>a</span><span>r</span><span>c</span><span>h</span><span>i</span><span>n</span><span>g</span><span>.</span><span>.</span><span>.</span>
                </p>
            </div>
        </div>

        <!-- Results Container -->
        <div id="result-container" class="hidden">
            <div class="result-card">
                <!-- Topic Header -->
                <div class="topic-header">
                    <p class="topic-label">Research Topic</p>
                    <h2 id="result-topic"></h2>
                </div>

                <!-- Confidence Score -->
                <div class="confidence-section">
                    <div class="confidence-meter">
                        <div class="confidence-fill" id="confidence-fill"></div>
                    </div>
                    <div class="confidence-label">
                        <span>Confidence</span><br>
                        <span class="confidence-value" id="confidence-value">--</span>
                    </div>
                </div>

                <!-- Summary -->
                <div class="summary-section">
                    <h3 class="section-title">ğŸ“ Summary</h3>
                    <p id="result-summary"></p>
                </div>

                <!-- Sources & Tools -->
                <div class="meta-grid">
                    <div class="meta-section">
                        <h4>ğŸ”— Sources</h4>
                        <ul class="meta-list" id="result-sources"></ul>
                    </div>
                    <div class="meta-section">
                        <h4>ğŸ› ï¸ Tools Used</h4>
                        <ul class="meta-list" id="result-tools-used"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Container -->
        <div id="error-container" class="hidden">
            <div class="result-card">
                <div class="error-container">
                    <div class="error-icon">âš ï¸</div>
                    <p class="error-title">Something went wrong</p>
                    <p class="error-message" id="error-message"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Allow Enter key to submit
        document.getElementById('query').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                askAgent();
            }
        });

        function askAgent() {
            const query = document.getElementById('query').value.trim();
            if (!query) return;

            const loadingElement = document.getElementById('loading');
            const resultContainer = document.getElementById('result-container');
            const errorContainer = document.getElementById('error-container');
            const askButton = document.getElementById('askButton');

            // Show loading, hide results
            loadingElement.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');
            askButton.disabled = true;
            askButton.textContent = 'â³ Researching...';

            fetch('/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            })
                .then(res => res.json())
                .then(data => {
                    loadingElement.classList.add('hidden');
                    askButton.disabled = false;
                    askButton.textContent = 'âœ¨ Start Research';

                    if (data.error) {
                        errorContainer.classList.remove('hidden');
                        document.getElementById('error-message').textContent = data.error;
                        if (data.raw_response) {
                            document.getElementById('error-message').textContent += '\n\nRaw Response: ' + data.raw_response;
                        }
                    } else {
                        resultContainer.classList.remove('hidden');

                        // Parse result - handle both string and object
                        let result;
                        if (typeof data.result === 'string') {
                            // Try to parse as JSON first
                            try {
                                // Remove the model prefix if present
                                const jsonStr = data.result.replace(/^ResearchResponse\(/, '').replace(/\)$/, '');
                                // Convert Python-style to JSON
                                const cleanJson = jsonStr
                                    .replace(/topic=/g, '"topic":')
                                    .replace(/summary=/g, '"summary":')
                                    .replace(/sources=/g, '"sources":')
                                    .replace(/tools_used=/g, '"tools_used":')
                                    .replace(/confidence_score=/g, '"confidence_score":')
                                    .replace(/'/g, '"');
                                result = JSON.parse('{' + cleanJson + '}');
                            } catch (e) {
                                // If parsing fails, try eval-like extraction
                                result = extractFromPydantic(data.result);
                            }
                        } else {
                            result = data.result;
                        }

                        // Populate topic
                        document.getElementById('result-topic').textContent = result.topic || 'Research Results';

                        // Populate summary
                        document.getElementById('result-summary').textContent = result.summary || 'No summary available.';

                        // Populate confidence score
                        const confidence = result.confidence_score || 0;
                        const confidencePercent = Math.round(confidence * 100);
                        const confidenceFill = document.getElementById('confidence-fill');
                        const confidenceValue = document.getElementById('confidence-value');

                        confidenceFill.style.width = confidencePercent + '%';
                        confidenceValue.textContent = confidencePercent + '%';

                        // Set confidence level class
                        confidenceFill.className = 'confidence-fill';
                        confidenceValue.className = 'confidence-value';
                        if (confidence >= 0.7) {
                            confidenceFill.classList.add('high');
                            confidenceValue.classList.add('high');
                        } else if (confidence >= 0.4) {
                            confidenceFill.classList.add('medium');
                            confidenceValue.classList.add('medium');
                        } else {
                            confidenceFill.classList.add('low');
                            confidenceValue.classList.add('low');
                        }

                        // Populate sources
                        const sourcesList = document.getElementById('result-sources');
                        sourcesList.innerHTML = '';
                        (result.sources || []).forEach(source => {
                            const li = document.createElement('li');
                            li.innerHTML = `<span class="source-icon">ğŸ”—</span>${source}`;
                            sourcesList.appendChild(li);
                        });

                        // Populate tools used
                        const toolsUsedList = document.getElementById('result-tools-used');
                        toolsUsedList.innerHTML = '';
                        (result.tools_used || []).forEach(tool => {
                            const li = document.createElement('li');
                            const toolIcon = getToolIcon(tool);
                            li.innerHTML = `<span class="tool-icon">${toolIcon}</span>${formatToolName(tool)}`;
                            toolsUsedList.appendChild(li);
                        });
                    }
                })
                .catch(error => {
                    loadingElement.classList.add('hidden');
                    errorContainer.classList.remove('hidden');
                    document.getElementById('error-message').textContent = 'Failed to connect to the server. Please try again.';
                    askButton.disabled = false;
                    askButton.textContent = 'âœ¨ Start Research';
                });
        }

        function extractFromPydantic(str) {
            // Extract values from Pydantic string representation
            const result = {};

            const topicMatch = str.match(/topic='([^']+)'/);
            if (topicMatch) result.topic = topicMatch[1];

            const summaryMatch = str.match(/summary='([^']+)'/);
            if (summaryMatch) result.summary = summaryMatch[1];

            const sourcesMatch = str.match(/sources=\[([^\]]+)\]/);
            if (sourcesMatch) {
                result.sources = sourcesMatch[1].split(',').map(s => s.trim().replace(/'/g, ''));
            }

            const toolsMatch = str.match(/tools_used=\[([^\]]+)\]/);
            if (toolsMatch) {
                result.tools_used = toolsMatch[1].split(',').map(s => s.trim().replace(/'/g, ''));
            }

            const confidenceMatch = str.match(/confidence_score=([\d.]+)/);
            if (confidenceMatch) result.confidence_score = parseFloat(confidenceMatch[1]);

            return result;
        }

        function getToolIcon(tool) {
            const icons = {
                'search': 'ğŸ”',
                'wikipedia': 'ğŸ“š',
                'wiki': 'ğŸ“š',
                'save': 'ğŸ’¾',
                'save_text_to_file': 'ğŸ’¾'
            };
            return icons[tool.toLowerCase()] || 'ğŸ› ï¸';
        }

        function formatToolName(tool) {
            const names = {
                'search': 'Web Search',
                'wikipedia': 'Wikipedia',
                'wiki': 'Wikipedia',
                'save': 'Save to File',
                'save_text_to_file': 'Save to File'
            };
            return names[tool.toLowerCase()] || tool;
        }
    </script>
</body>

</html>